name: PR Check, Auto-Merge and Update README

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'data/companies.yaml'
      - 'data/queries.yaml'
      - 'generate_readme.py'
      - 'readme.yaml'

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-merge-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Process PR, Approve and Merge
        id: merge_step
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const baseBranch = pr.base.ref;

            // 1. Check if rebase is needed
            const comparison = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: baseBranch,
              head: pr.head.sha,
            });

            if (comparison.data.behind_by > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `‚ö†Ô∏è @${pr.user.login}, please rebase your branch with **${baseBranch}** before merging.`,
              });
              core.setFailed("PR is out of date.");
              return;
            }

            // 2. Approve (if not self-PR)
            if (context.actor !== pr.user.login) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: "APPROVE",
                body: "Automated approval."
              });
            }

            // 3. Thank and Merge
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `Thanks for the contribution, @${pr.user.login}!`,
            });

            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: "squash",
            });

      - name: Set up Python
        # Only run this if the merge was successful
        if: success()
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        if: success()
        run: pip install pyyaml

      - name: Update README on Main
        if: success()
        run: |
          # Switch to the main branch which now contains the merged PR code
          git checkout main
          git pull origin main

          # Run your generation script
          python -m generate_readme

          # Configure Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Commit and push directly to main
          git add readme.md
          git diff-index --quiet HEAD || git commit -m "chore(üìö): update readme with fresh content"
          git push origin main
